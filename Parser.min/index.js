// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";function Hash(t){for(var e=t.length,n=5381;e--;)n+=(n<<5)+t.charCodeAt(e);return n}function Deduplication(t){if(0!=t.indexOf("http"))return t;for(var e="",n=0;n<t.length&&(e+=Math.random()>=.5?t[n].toUpperCase():t[n].toLowerCase(),"/"!=t[n]||"/"==t[n-1]||"/"==t[n+1]);n++);return e+=t.substring(n+1)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},parseHtmlSync=require("./libs/MpHtmlParser.js").parseHtmlSync,cache=getApp().parserCache={},CssHandler=require("./libs/CssHandler.js"),config=require("./libs/config.js"),document;try{document=require("./libs/document.js")}catch(t){}var hideAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(0).step().export(),showAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(1).step().export();Component({properties:{html:{type:null,value:null,observer:function(t){if(this._refresh)return this._refresh=!1;this.setContent(t,void 0,!0)}},autocopy:{type:Boolean,value:!0},autopause:{type:Boolean,value:!0},autopreview:{type:Boolean,value:!0},autosetTitle:{type:Boolean,value:!0},domain:{type:String,value:null},gestureZoom:{type:Boolean,value:!1},imgMode:{type:String,value:"default"},lazyLoad:{type:Boolean,value:!1},selectable:{type:Boolean,value:!1},tagStyle:{type:Object,value:{}},showWithAnimation:{type:Boolean,value:!1},useAnchor:{type:Boolean,value:!1},useCache:{type:Boolean,value:!1}},created:function(){var t=this;this.navigateTo=function(e){var n=t.createSelectorQuery();n.select("#contain"+(e.id?">>>#"+e.id:"")).boundingClientRect(),n.selectViewport().scrollOffset(),n.exec(function(t){if(!t||!t[0])return e.fail?e.fail({errMsg:"Label Not Found"}):null;wx.pageScrollTo({scrollTop:t[1].scrollTop+t[0].top,success:e.success,fail:e.fail})})},this.getText=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n="";if(!t.data.html||!t.data.html.length)return"";for(var a=0;a<t.data.html.length;a++)!function t(a){if("text"==a.type)return n+=a.text;if(e&&(("p"==a.name||"div"==a.name||"tr"==a.name||"li"==a.name||/h[1-6]/.test(a.name))&&n&&"\n"!=n[n.length-1]||"br"==a.name)&&(n+="\n"),a.children)for(var i=0;i<a.children.length;i++)t(a.children[i]);e&&("p"==a.name||"div"==a.name||"tr"==a.name||"li"==a.name||/h[1-6]/.test(a.name))&&n&&"\n"!=n[n.length-1]?n+="\n":e&&"td"==a.name&&(n+="\t")}(t.data.html[a]);return n},this.getVideoContext=function(e){if(!e)return t.videoContexts;for(var n=t.videoContexts.length;n--;)if(t.videoContexts[n].id==e)return t.videoContexts[n];return null},this.imgList=[],this.imgList.each=function(t){for(var e=0;e<this.length;e++){var n=t(this[e],e,this);n&&(this.includes(n)?this[e]=Deduplication(n):this[e]=n)}},this._refresh=!1,this.setContent=function(e,n,a){if("object"==(void 0===n?"undefined":_typeof(n)))for(var i in n)i=i.replace(/-(\w)/g,function(t,e){return e.toUpperCase()}),t.data[i]=n[i];var o={controls:{imgMode:t.data.imgMode}};if(t.data.showWithAnimation&&(o.showAnimation=showAnimation,o.hideAnimation=hideAnimation),e)if("string"==typeof e){if(t.data.useCache){var r=Hash(e);cache[r]?o.html=cache[r]:(o.html=parseHtmlSync(e,t.data),cache[r]=o.html)}else o.html=parseHtmlSync(e,t.data);t.triggerEvent("parse",o.html)}else if(e.constructor==Array){if(e.length&&"Parser"!=e[0].PoweredBy){var s={_imgNum:0,_videoNum:0,_audioNum:0,_domain:t.data.domain,_protocol:t.data.domain?t.data.domain.includes("://")?t.data.domain.split("://")[0]:"http":void 0,_STACK:[],CssHandler:new CssHandler(t.data.tagStyle)};s.CssHandler.getStyle(""),function t(e){for(var n,a=0;n=e[a++];)if("text"!=n.type){n.attrs=n.attrs||{};for(var i in n.attrs)config.trustAttrs[i]?"string"!=typeof n.attrs[i]&&(n.attrs[i]=n.attrs[i].toString()):n.attrs[i]=void 0;config.LabelAttrsHandler(n,s),config.blockTags[n.name]?n.name="div":config.trustTags[n.name]||(n.name="span"),n.children&&n.children.length?(s._STACK.push(n),t(n.children),s._STACK.pop()):n.children=void 0}}(e),o.html=e}a||(o.html=e)}else{if("object"!=(void 0===e?"undefined":_typeof(e))||!e.nodes)return t.triggerEvent("error",{source:"parse",errMsg:"错误的html类型："+(void 0===e?"undefined":_typeof(e))});o.html=e.nodes,console.warn("Parser 类型错误：object 类型已废弃，请直接将 html 设置为 object.nodes （array 类型）")}else{if(a)return;o.html=""}t._refresh=!!o.html,t.setData(o),t.imgList.length=0,t.videoContexts=[],document&&(t.document=new document("html",o.html||e,t));for(var l=[t.selectComponent("#contain")].concat(t.selectAllComponents("#contain>>>._node")),c=l.length;c--;){var h,u,d,u,d,m;!function(){var e=l[c];for(e._top=t,h=!!e._observer,u=e.data.nodes.length,u=e.data.nodes.length;d=e.data.nodes[--u];)d.continue||("img"==d.name?(d.attrs.src&&d.attrs.i&&(-1==t.imgList.indexOf(d.attrs.src)?t.imgList[d.attrs.i]=d.attrs.src:t.imgList[d.attrs.i]=Deduplication(d.attrs.src)),h||(h=!0,(wx.nextTick||setTimeout)(function(){t.data.lazyLoad&&e.createIntersectionObserver?(e._observer=e.createIntersectionObserver(),e._observer.relativeToViewport({top:1e3,bottom:1e3}).observe("._img",function(){e.setData({imgLoad:!0}),e._observer.disconnect(),e._observer=void 0})):e.setData({imgLoad:!0})},50))):"video"==d.name?(m=wx.createVideoContext(d.attrs.id,e),m.id=d.attrs.id,t.videoContexts.push(m)):"audio"==d.name&&d.attrs.autoplay?wx.createAudioContext(d.attrs.id,e).play():"title"==d.name&&t.data.autosetTitle&&"text"==d.children[0].type&&d.children[0].text&&wx.setNavigationBarTitle({title:d.children[0].text}))}()}(wx.nextTick||setTimeout)(function(){t.createSelectorQuery().select("#contain").boundingClientRect(function(e){t.triggerEvent("ready",e)}).exec()},50)}},methods:{tap:function(t){this.data.gestureZoom&&t.timeStamp-this.lastTime<300&&(this.animation=wx.createAnimation({transformOrigin:t.detail.x-t.currentTarget.offsetLeft+"px "+(t.detail.y-t.currentTarget.offsetTop)+"px 0"}),this.zoomIn?this.animation.scale(1).step():(this.animation.scale(2).step(),this.translateX=0),this.zoomIn=!this.zoomIn,this.setData({showAnimation:this.animation.export()})),this.lastTime=t.timeStamp},touchstart:function(t){1==t.touches.length&&(this.lastX=t.touches[0].pageX)},touchmove:function(t){var e=t.touches[0].pageX-this.lastX;this.zoomIn&&1==t.touches.length&&Math.abs(e)>20&&(this.translateX+=e,Math.abs(this.translateX)<100?this.animation.translateX(this.translateX).step():(this.animation.translateX(0).scale(1).step(),this.zoomIn=!1),this.setData({showAnimation:this.animation.export()}),this.lastX=t.touches[0].pageX)}}});